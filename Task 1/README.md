# Архитектура страховой комании Insure Tech

Задание 1. Технологическая архитектура


На схеме указана архитектура одного региона, подход предлагается распространить на все регионы обслуживания

![Технологическая архитектура](./InsureTech_технологическая_архитектура-TO-BE.drawio.svg)

Стратегия отказоустойчивости:

Cluster Autoscaler + Horizontal Pod Autoscaler (HPA) на основе мониторинга количества запросов в секунду (RPS) 

В силу того, что доступность должна быть 99,995% при RTO = 45 мин, рекомендуется посмотреть в сторону Active-Active failover стратегии. Доступность очень высокая, рост нагрузки в перспективе сложно предсказать при росте бизнеса - лучше иметь дополнительный активный кластер для работы. Важно учесть, чтобы нагрузка между кластерами распределялась 50\50, а при падении одного из кластеров, рабочий кластер мог бы взять 100% нагрузку


Машрутизация и балансировка со стороны клиента

* Через GLSB - т.к бизнес ориентируется на региональное обслуживание клиентов. Важно иметь балансировку по географическому признаку. GLSB будет направлять клиентов к ближайшему региональному кластеру. 	Управление кластером Kubernetes в рамках 1-го региона объединенное, 1 регион = 1 кластер.


Реализация кластера PostgreSQL:
* HAProxy + pgBouncer + Patroni + etcd. HAProxy + pgBouncer - для маршрутизации и контроля пула подключений с клиентской стороны. Patroni + etcd - контроль за работой кластера БД: выбор лида, проверка состояния нод 
* В кажом кластере БД минимально 3 ноды, где 1 лидер, 2 реплики. Мониторинг лида и реплик происходит через Patroni + etcd
* Репликация внутри кластера на ЦОД через WAL журнал - стриминговая репликация между нодами.
* Между ЦОД предлагается репликация также через WAL, но с использованием CDC(Debezium) + Kafka. - также можно реализовать класетер для групп консьюмеров и продьюсеров, на текущей схеме не раскрыто
* Лиды нод PostgreSQL через свои воркеры(продьюсер\консьюмер) будут согласовывать свое состояние между собой асинхронно.


В дополнение предлагается делать бекапы PgData + WAL и писать это в S3 облачное хранилище.

При текущей реализации БД сохраняют свою целостность, шардирование не предусмотрено. К шарированию БД на более точечные региональные деления (например, с учетом часовых поясов) рекомендуется вернуться после оценки выросшей нагрузки, сейчас деление избыточно.
